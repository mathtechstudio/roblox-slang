name: Changelog Check

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches:
      - main
      - develop

jobs:
  check-changelog:
    name: Check Changelog Updated
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if changelog updated
        id: changelog
        run: |
          # Check if PR has "skip changelog" label
          if gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name' | grep -q "skip changelog"; then
            echo "PR has 'skip changelog' label, skipping check"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if CHANGELOG.md was modified
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
            echo "✓ CHANGELOG.md has been updated"
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "✗ CHANGELOG.md has not been updated"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR if changelog not updated
        if: steps.changelog.outputs.updated == 'false' && steps.changelog.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              '## ⚠️ Changelog Not Updated',
              '',
              'This PR does not include changes to `CHANGELOG.md`.',
              '',
              'Please update the changelog with your changes under the `[Unreleased]` section:',
              '',
              '```markdown',
              '## [Unreleased]',
              '',
              '### Added',
              `- Your new feature (#${context.issue.number})`,
              '',
              '### Changed',
              `- Your changes (#${context.issue.number})`,
              '',
              '### Fixed',
              `- Your bug fix (#${context.issue.number})`,
              '```',
              '',
              'If this PR doesn\'t require a changelog entry (e.g., documentation, tests only), add the `skip changelog` label.',
              '',
              '**Format:**',
              '- Use present tense ("Add feature" not "Added feature")',
              `- Reference the PR number: \`(#${context.issue.number})\``,
              '- Group changes by type: Added, Changed, Fixed, Deprecated, Removed, Security',
              '',
              '**Example:**',
              '```markdown',
              '### Added',
              `- Support for YAML input files (#${context.issue.number})`,
              `- New \`--watch\` flag for auto-rebuild (#${context.issue.number})`,
              '',
              '### Fixed',
              `- Parser crash on empty JSON files (#${context.issue.number})`,
              '```'
            ].join('\n');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: body
            });

      - name: Fail if changelog not updated
        if: steps.changelog.outputs.updated == 'false' && steps.changelog.outputs.skip != 'true'
        run: |
          echo "::error::CHANGELOG.md has not been updated. Please update the changelog or add 'skip changelog' label."
          exit 1

      - name: Success message
        if: steps.changelog.outputs.updated == 'true' || steps.changelog.outputs.skip == 'true'
        run: |
          if [ "${{ steps.changelog.outputs.skip }}" == "true" ]; then
            echo "✓ Changelog check skipped (has 'skip changelog' label)"
          else
            echo "✓ Changelog has been updated"
          fi
